#write-kubeconfig-mode: "0644"
cluster-init: true

node-ip: {{ private_ip }}
advertise-address: {{ private_ip }}
node-external-ip: {{ ansible_host }}
cluster-domain: {{ k8s.cluster_domain }}
cluster-cidr: {{ k8s.cluster_cidr }}
service-cidr: {{ k8s.service_cidr }}

{% if k3s.node_labels is defined -%}
node-label:
{% for label in k3s.node_labels %}
  - {{label}}
{% endfor %}
{% endif %}

disable:
  - traefik # Let's deploy our own so it's decoupled from k3s updates.
  - local-storage

# hcloud-ccm replaces the built-in cloud controller
disable-cloud-controller: true

# Some components need to be disabled so we can replace them with Cilium
flannel-backend: "none"
disable-network-policy: true

# Taint control plane
node-taint:
  - "node-role.kubernetes.io/control-plane:NoSchedule"

# Harden the cluster
protect-kernel-defaults: true
secrets-encryption: true
kube-apiserver-arg:
  - "feature-gates=UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true"
  - "enable-admission-plugins=NodeRestriction"
  - 'admission-control-config-file=/var/lib/rancher/k3s/server/psa.yaml'
kube-scheduler-arg:
  - "feature-gates=UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true"
kube-controller-manager-arg:
  - "feature-gates=UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true"
  - 'terminated-pod-gc-threshold=10'
kubelet-arg:
  - "feature-gates=UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true"
  - 'streaming-connection-idle-timeout=5m'
  - "tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
  - "cloud-provider=external" # Needed for hcloud-ccm
kube-proxy-arg:
  - "feature-gates=UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true"
