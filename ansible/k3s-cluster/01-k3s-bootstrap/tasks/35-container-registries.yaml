- name: Create namespaces for registry secrets
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item.namespace }}"
  loop: "{{ registries }}"

- name: Create registry secrets
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ item.name }}"
        namespace: "{{ item.namespace }}"
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: "{{ dockerconfig | to_json | b64encode }}"
  vars:
    dockerconfig:
      auths:
        "{{ item.registry_server }}":
          username: "{{ item.username }}"
          password: "{{ item.password }}"
          email: "{{ item.email | default('') }}"
          auth: "{{ (item.username + ':' + item.password) | b64encode }}"
  loop: "{{ registries }}"
  no_log: true  # Prevents passwords from appearing in logs